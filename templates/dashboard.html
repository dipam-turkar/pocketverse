{% extends "base.html" %}

{% block title %}Dashboard - {{ user.display_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welcome, {{ user.display_name }}!</h1>
    {% if user.is_official %}
        <p class="subtitle">‚≠ê Official Character Dashboard</p>
        {% set char_data = user.get_character_data() %}
        {% if char_data.get('show_name') %}
            <p class="subtitle">from <em>{{ char_data.show_name }}</em></p>
        {% endif %}
    {% endif %}
</div>

<div class="dashboard-container">
    <div class="dashboard-tabs">
        <button class="tab-btn active" onclick="showTab('create-post')">Create Post</button>
        <button class="tab-btn" onclick="showTab('create-comment')">Create Comment</button>
        <button class="tab-btn" onclick="showTab('recent')">Recent Activity</button>
    </div>

    <!-- Create Post Tab -->
    <div id="create-post" class="tab-content active">
        <div class="dashboard-section">
            <h2>Create New Post</h2>
            <form method="POST" action="{{ url_for('main.create_post_dashboard') }}" class="form">
                <div class="form-group">
                    <label for="pocketshow_id">Pocketshow *</label>
                    <select id="pocketshow_id" name="pocketshow_id" required>
                        <option value="">Select a pocketshow</option>
                        {% for pocketshow in pocketshows %}
                            <option value="{{ pocketshow.id }}">r/{{ pocketshow.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">Post Title *</label>
                    <input type="text" id="title" name="title" required maxlength="200">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="2" placeholder="Optional description"></textarea>
                </div>

                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" name="content" rows="6" placeholder="Post content"></textarea>
                </div>

                <!-- Image Section -->
                <div class="form-group">
                    <label>Image</label>
                    <div class="image-options">
                        <div class="image-option-tabs">
                            <button type="button" class="img-tab-btn active" onclick="showImageTab('upload')">Upload Image</button>
                            <button type="button" class="img-tab-btn" onclick="showImageTab('generate')">Generate Image</button>
                        </div>

                        <!-- Upload Tab -->
                        <div id="image-upload-tab" class="image-tab-content active">
                            <input type="file" id="image_file" name="image" accept="image/*" onchange="handleImageUpload(event)">
                            <div id="upload-preview" class="image-preview" style="display: none;">
                                <img id="upload-preview-img" src="" alt="Preview">
                                <button type="button" class="btn btn-secondary" onclick="clearImagePreview()">Remove</button>
                            </div>
                        </div>

                        <!-- Generate Tab -->
                        <div id="image-generate-tab" class="image-tab-content">
                            <div class="form-group">
                                <label for="image_prompt">Image Prompt *</label>
                                <textarea id="image_prompt" name="image_prompt" rows="3" placeholder="Describe the image you want to generate..."></textarea>
                                <small>This will be enhanced with your character's story context</small>
                            </div>

                            <div class="form-group">
                                <label for="custom_prompt">Custom Prompt (Optional)</label>
                                <textarea id="custom_prompt" name="custom_prompt" rows="2" placeholder="Override the prompt completely if needed"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="plot_points">Plot Points (Optional)</label>
                                <input type="text" id="plot_points" name="plot_points" placeholder="Comma-separated plot points">
                            </div>

                            <div class="form-group">
                                <label for="subplots">Subplots (Optional)</label>
                                <input type="text" id="subplots" name="subplots" placeholder="Comma-separated subplots">
                            </div>

                            <div class="form-group">
                                <label for="cliffhangers">Cliffhangers (Optional)</label>
                                <input type="text" id="cliffhangers" name="cliffhangers" placeholder="Comma-separated cliffhangers">
                            </div>

                            <button type="button" class="btn btn-secondary" onclick="generateImage()">Generate Image</button>
                            
                            <div id="generate-status" style="display: none; margin-top: 1rem;"></div>
                            <div id="generate-preview" class="image-preview" style="display: none;">
                                <img id="generate-preview-img" src="" alt="Generated Preview">
                                <div class="preview-actions">
                                    <button type="button" class="btn btn-primary" onclick="acceptImage()">Accept & Use</button>
                                    <button type="button" class="btn btn-secondary" onclick="rejectImage()">Reject & Regenerate</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="final_image_url" name="image_url">
                </div>

                <div class="form-group">
                    <label for="video_url">Video URL</label>
                    <input type="url" id="video_url" name="video_url" placeholder="https://example.com/video.mp4">
                </div>

                <button type="submit" class="btn btn-primary">Create Post</button>
            </form>
        </div>
    </div>

    <!-- Create Comment Tab -->
    <div id="create-comment" class="tab-content">
        <div class="dashboard-section">
            <h2>Create New Comment</h2>
            <form method="POST" action="{{ url_for('main.create_comment_dashboard') }}" class="form">
                <div class="form-group">
                    <label for="post_id">Post ID *</label>
                    <input type="number" id="post_id" name="post_id" required placeholder="Enter the post ID to comment on">
                    <small>You can find the post ID in the URL when viewing a post</small>
                </div>

                <div class="form-group">
                    <label for="content">Comment Content *</label>
                    <textarea id="content" name="content" rows="6" required placeholder="Your comment"></textarea>
                </div>

                <div class="form-group">
                    <label for="parent_id">Parent Comment ID (Optional)</label>
                    <input type="number" id="parent_id" name="parent_id" placeholder="Leave empty for top-level comment">
                    <small>Enter a comment ID if this is a reply to another comment</small>
                </div>

                <button type="submit" class="btn btn-primary">Create Comment</button>
            </form>
        </div>
    </div>

    <!-- Recent Activity Tab -->
    <div id="recent" class="tab-content">
        <div class="dashboard-section">
            <h2>Recent Posts</h2>
            {% if recent_posts %}
                <div class="recent-list">
                    {% for post in recent_posts %}
                        <div class="recent-item">
                            <h3><a href="{{ url_for('main.view_post', post_id=post.id) }}">{{ post.title }}</a></h3>
                            <p class="meta">Posted {{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            <p class="meta">{{ post.comments|length }} comments</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-state">No posts yet</p>
            {% endif %}
        </div>

        <div class="dashboard-section" style="margin-top: 2rem;">
            <h2>Recent Comments</h2>
            {% if recent_comments %}
                <div class="recent-list">
                    {% for comment in recent_comments %}
                        <div class="recent-item">
                            <p>{{ comment.content[:100] }}{% if comment.content|length > 100 %}...{% endif %}</p>
                            <p class="meta">
                                <a href="{{ url_for('main.view_post', post_id=comment.post_id) }}">View Post</a> | 
                                Posted {{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                            </p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-state">No comments yet</p>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

function showImageTab(tabName) {
    // Hide all image tabs
    document.querySelectorAll('.image-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all image tab buttons
    document.querySelectorAll('.img-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    if (tabName === 'upload') {
        document.getElementById('image-upload-tab').classList.add('active');
    } else {
        document.getElementById('image-generate-tab').classList.add('active');
    }
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('/dashboard/upload_image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const preview = document.getElementById('upload-preview');
            const previewImg = document.getElementById('upload-preview-img');
            previewImg.src = data.image_url;
            preview.style.display = 'block';
            document.getElementById('final_image_url').value = data.image_url;
        } else {
            alert('Error uploading image: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to upload image');
    });
}

function clearImagePreview() {
    document.getElementById('upload-preview').style.display = 'none';
    document.getElementById('image_file').value = '';
    document.getElementById('final_image_url').value = '';
}

function generateImage() {
    const prompt = document.getElementById('image_prompt').value.trim();
    const customPrompt = document.getElementById('custom_prompt').value.trim();
    
    if (!prompt && !customPrompt) {
        alert('Please enter an image prompt');
        return;
    }
    
    const formData = new FormData();
    formData.append('prompt', prompt);
    if (customPrompt) {
        formData.append('custom_prompt', customPrompt);
    }
    
    const plotPoints = document.getElementById('plot_points').value.trim();
    const subplots = document.getElementById('subplots').value.trim();
    const cliffhangers = document.getElementById('cliffhangers').value.trim();
    
    if (plotPoints) formData.append('plot_points', plotPoints);
    if (subplots) formData.append('subplots', subplots);
    if (cliffhangers) formData.append('cliffhangers', cliffhangers);
    
    const statusDiv = document.getElementById('generate-status');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<p>Generating image... This may take a moment.</p>';
    
    fetch('/dashboard/generate_image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.style.display = 'none';
        
        if (data.success) {
            const preview = document.getElementById('generate-preview');
            const previewImg = document.getElementById('generate-preview-img');
            previewImg.src = data.image_url;
            preview.style.display = 'block';
        } else {
            statusDiv.innerHTML = '<p style="color: red;">Error: ' + data.error + '</p>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<p style="color: red;">Failed to generate image</p>';
    });
}

function acceptImage() {
    // Save the generated image
    fetch('/dashboard/save_image', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('final_image_url').value = data.image_url;
            alert('Image accepted! You can now create your post.');
        } else {
            alert('Error saving image: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save image');
    });
}

function rejectImage() {
    // Clean up rejected image on server
    fetch('/dashboard/reject_image', {
        method: 'POST'
    })
    .catch(error => {
        console.error('Error cleaning up rejected image:', error);
    });
    
    document.getElementById('generate-preview').style.display = 'none';
    document.getElementById('image_prompt').value = '';
    document.getElementById('custom_prompt').value = '';
    document.getElementById('final_image_url').value = '';
}
</script>
{% endblock %}
{% endblock %}

